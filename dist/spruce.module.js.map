{"version":3,"file":"spruce.module.js","sources":["../src/utils.js","../src/observable.js","../src/index.js"],"sourcesContent":["export const domReady = () => {\n    return new Promise(resolve => {\n        if (document.readyState == \"loading\") {\n            document.addEventListener(\"DOMContentLoaded\", resolve)\n        } else {\n            resolve()\n        }\n    })\n}\n\nexport const isNullOrUndefined = value => {\n    return value === null || value === undefined\n}\n\nexport const isObject = _ => {\n    return Object.getPrototypeOf(_) === Object.prototype\n}\n\nexport const isArray = _ => Array.isArray(_)\n\nexport const getMethods = obj => {\n    let methods = {}\n\n    Object.entries(obj).filter(([key, value]) => typeof value === 'function').forEach(([key, value]) => methods[key] = value)\n\n    return methods\n}\n\nexport const isTesting = () => {\n    return navigator.userAgent, navigator.userAgent.includes(\"Node.js\")\n        || navigator.userAgent.includes(\"jsdom\")\n}\n\nexport const checkForAlpine = () => {\n    return isTesting() || (! window.Alpine || ! compareVersions.compare(window.Alpine.version, '2.7.0', '>='))\n}","import { isNullOrUndefined, isObject, isArray } from './utils'\n\nexport const createObservable = (target, callbacks) => {\n    Object.entries(target).forEach(([key, value]) => {\n        if (! isNullOrUndefined(value) && (isObject(value) || isArray(value))) {\n            target[key] = createObservable(value, callbacks)\n        }\n    })\n\n    return new Proxy(target, {\n        set(target, key, value) {\n            if (! isNullOrUndefined(value) && isObject(value)) {\n                value = createObservable(value, callbacks)\n            }\n\n            callbacks.set(target, key, target[key] = value)\n\n            return true\n        }\n    })\n}","import { domReady, getMethods, checkForAlpine } from './utils'\nimport { createObservable } from './observable'\n\nconst Spruce = {\n    stores: {},\n\n    persisted: [],\n\n    subscribers: [],\n\n    watchers: {},\n\n    disableReactivity: false,\n\n    async start() {\n        await domReady()\n\n        this.attach()\n\n        this.stores = createObservable(this.stores, {\n            set: (target, key, value) => {\n                if (this.disableReactivity) {\n                    return\n                }\n\n                this.updateSubscribers()\n\n                this.runWatchers(this.stores, target, key, value)\n\n                this.disableReactivity = true\n\n                try {\n                    this.persisted.forEach(this.updateLocalStorage.bind(this))\n                } catch (e) {\n                    // Do nothing here (thanks Safari!)\n                }\n\n                this.disableReactivity = false\n            }\n        })\n    },\n\n    attach() {\n        if (! checkForAlpine()) {\n            throw new Error('[Spruce] You must be using Alpine >= 2.5.0 to use Spruce.')\n        }\n\n        const self = this\n\n        window.Alpine.addMagicProperty('store', el => {\n            self.subscribe(el)\n\n            return self.stores\n        })\n    },\n\n    store(name, state, persist = false) {\n        if (persist) {\n            try {\n                this.stores[name] = this.retrieveFromLocalStorage(name, getMethods(state))\n\n                if (!this.persisted.includes(name)) {\n                    this.persisted.push(name)\n                }\n            } catch (e) {\n                // Do nothing here (thanks Safari!)\n            }\n        }\n\n        if (!this.stores[name]) {\n            this.stores[name] = state\n        }\n\n        return this.stores[name]\n    },\n\n    reset(name, state) {\n        this.stores[name] = state\n    },\n\n    subscribe(el) {\n        if (!this.subscribers.includes(el)) {\n            this.subscribers.push(el)\n        }\n\n        return this.stores\n    },\n\n    updateSubscribers() {\n        this.subscribers.filter(el => !!el.__x).forEach(el => {\n            el.__x.updateElements(el)\n        })\n    },\n\n    retrieveFromLocalStorage(name, methods = {}) {\n        const storage = JSON.parse(window.localStorage.getItem(`__spruce:${name}`))\n\n        return storage ? Object.assign(methods, storage) : null\n    },\n\n    updateLocalStorage(name) {\n        window.localStorage.setItem(`__spruce:${name}`, JSON.stringify(this.store(name)))\n    },\n\n    watch(name, callback) {\n        if (!this.watchers[name]) {\n            this.watchers[name] = []\n        }\n\n        this.watchers[name].push(callback)\n    },\n\n    runWatchers(stores, target, key, value) {\n        const self = this\n\n        if (self.watchers[key]) {\n            return self.watchers[key].forEach(callback => callback(value))\n        }\n\n        Object.keys(self.watchers)\n            .filter(watcher => watcher.includes('.'))\n            .forEach(fullDotNotationKey => {\n                let dotNotationParts = fullDotNotationKey.split('.')\n\n                if (key !== dotNotationParts[dotNotationParts.length - 1]) return\n\n                dotNotationParts.reduce((comparison, part) => {\n                    if (comparison[key] === target[key] || Object.is(target, comparison)) {\n                        self.watchers[fullDotNotationKey].forEach(callback => callback(value))\n                    }\n\n                    return comparison[part]\n                }, stores)\n            })\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || function (callback) { callback() }\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce\n"],"names":["const","isNullOrUndefined","value","isObject","_","Object","getPrototypeOf","prototype","createObservable","target","callbacks","entries","forEach","Array","isArray","key","Proxy","set","Spruce","stores","persisted","subscribers","watchers","disableReactivity","start","this","Promise","resolve","document","readyState","addEventListener","attach","_this","updateSubscribers","runWatchers","updateLocalStorage","bind","e","navigator","userAgent","includes","window","Alpine","compareVersions","compare","version","Error","self","addMagicProperty","el","subscribe","store","name","state","persist","retrieveFromLocalStorage","methods","filter","push","reset","__x","updateElements","storage","JSON","parse","localStorage","getItem","assign","setItem","stringify","watch","callback","keys","watcher","fullDotNotationKey","dotNotationParts","split","length","reduce","comparison","part","is","deferrer","deferLoadingAlpine"],"mappings":"AAAOA,IAUMC,WAAoBC,UACtBA,MAAAA,GAGEC,WAAWC,UACbC,OAAOC,eAAeF,KAAOC,OAAOE,WCblCC,WAAoBC,EAAQC,UACrCL,OAAOM,QAAQF,GAAQG,sCACbX,EAAkBC,KAAWC,EAASD,KDcxBW,MAAMC,QCdoCZ,KAC1DO,EAAOM,GAAOP,EAAiBN,EAAOQ,MAIvC,IAAIM,MAAMP,EAAQ,CACrBQ,aAAIR,EAAQM,EAAKb,UACPD,EAAkBC,IAAUC,EAASD,KACvCA,EAAQM,EAAiBN,EAAOQ,IAGpCA,EAAUO,IAAIR,EAAQM,EAAKN,EAAOM,GAAOb,IAElC,MCdbgB,EAAS,CACXC,OAAQ,GAERC,UAAW,GAEXC,YAAa,GAEbC,SAAU,GAEVC,mBAAmB,EAEbC,2BAGFC,4BFhBG,IAAIC,iBAAQC,GACY,WAAvBC,SAASC,WACTD,SAASE,iBAAiB,mBAAoBH,GAE9CA,yBEYCI,WAEAZ,OAASX,EAAiBwB,EAAKb,OAAQ,CACxCF,aAAMR,EAAQM,EAAKb,OACX8B,EAAKT,qBAIJU,sBAEAC,YAAYF,EAAKb,OAAQV,EAAQM,EAAKb,KAEtCqB,mBAAoB,QAGhBH,UAAUR,QAAQoB,EAAKG,mBAAmBC,SACjD,MAAOC,MAIJd,mBAAoB,4CAKrCQ,sBFbOO,UAA+BC,UAAUC,SAAS,aAClDF,UAAUC,UAAUC,SAAS,UAIXC,OAAOC,QAAYC,gBAAgBC,QAAQH,OAAOC,OAAOG,QAAS,QAAS,YEUtF,IAAIC,MAAM,iEAGdC,EAAOtB,KAEbgB,OAAOC,OAAOM,iBAAiB,iBAASC,UACpCF,EAAKG,UAAUD,GAERF,EAAK5B,UAIpBgC,eAAMC,EAAMC,EAAOC,sBAAU,GACrBA,WAESnC,OAAOiC,GAAQ3B,KAAK8B,yBAAyBH,GFtC1DI,EAAU,GAEdnD,OAAOM,QEoCwE0C,GFpC3DI,yBAA0C,0BAAY7C,2BAA0B4C,eAE7FA,IEoCU/B,KAAKL,UAAUoB,SAASY,SACpBhC,UAAUsC,KAAKN,GAE1B,MAAOf,QF3CbmB,SEgDK/B,KAAKN,OAAOiC,UACRjC,OAAOiC,GAAQC,GAGjB5B,KAAKN,OAAOiC,IAGvBO,eAAMP,EAAMC,QACHlC,OAAOiC,GAAQC,GAGxBH,mBAAUD,UACDxB,KAAKJ,YAAYmB,SAASS,SACtB5B,YAAYqC,KAAKT,GAGnBxB,KAAKN,QAGhBc,kCACSZ,YAAYoC,gBAAOR,WAAQA,EAAGW,MAAKhD,iBAAQqC,GAC5CA,EAAGW,IAAIC,eAAeZ,MAI9BM,kCAAyBH,EAAMI,kBAAU,QAC/BM,EAAUC,KAAKC,MAAMvB,OAAOwB,aAAaC,oBAAoBd,WAE5DU,EAAUzD,OAAO8D,OAAOX,EAASM,GAAW,MAGvD3B,4BAAmBiB,GACfX,OAAOwB,aAAaG,oBAAoBhB,EAAQW,KAAKM,UAAU5C,KAAK0B,MAAMC,MAG9EkB,eAAMlB,EAAMmB,GACH9C,KAAKH,SAAS8B,UACV9B,SAAS8B,GAAQ,SAGrB9B,SAAS8B,GAAMM,KAAKa,IAG7BrC,qBAAYf,EAAQV,EAAQM,EAAKb,OACvB6C,EAAOtB,QAETsB,EAAKzB,SAASP,UACPgC,EAAKzB,SAASP,GAAKH,iBAAQ2D,UAAYA,EAASrE,KAG3DG,OAAOmE,KAAKzB,EAAKzB,UACZmC,gBAAOgB,UAAWA,EAAQjC,SAAS,OACnC5B,iBAAQ8D,OACDC,EAAmBD,EAAmBE,MAAM,KAE5C7D,IAAQ4D,EAAiBA,EAAiBE,OAAS,IAEvDF,EAAiBG,gBAAQC,EAAYC,UAC7BD,EAAWhE,KAASN,EAAOM,IAAQV,OAAO4E,GAAGxE,EAAQsE,KACrDhC,EAAKzB,SAASoD,GAAoB9D,iBAAQ2D,UAAYA,EAASrE,KAG5D6E,EAAWC,IACnB7D,OAKb+D,EAAWzC,OAAO0C,oBAAsB,SAAUZ,GAAYA,KAEpE9B,OAAO0C,mBAAqB,SAAUZ,GAClC9B,OAAOvB,OAASA,EAChBuB,OAAOvB,OAAOM,QAEd0D,EAASX"}