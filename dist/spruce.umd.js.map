{"version":3,"file":"spruce.umd.js","sources":["../src/utils.js","../src/observable.js","../node_modules/compare-versions/index.js","../src/index.js"],"sourcesContent":["export const domReady = () => {\n    return new Promise(resolve => {\n        if (document.readyState == \"loading\") {\n            document.addEventListener(\"DOMContentLoaded\", resolve)\n        } else {\n            resolve()\n        }\n    })\n}\n\nexport const isNullOrUndefined = value => {\n    return value === null || value === undefined\n}\n\nexport const isObject = _ => {\n    return Object.getPrototypeOf(_) === Object.prototype\n}\n\nexport const isArray = _ => Array.isArray(_)\n\nexport const getMethods = obj => {\n    let methods = {}\n\n    Object.entries(obj).filter(([key, value]) => typeof value === 'function').forEach(([key, value]) => methods[key] = value)\n\n    return methods\n}","import { isNullOrUndefined, isObject, isArray } from './utils'\n\nexport const createObservable = (target, callbacks) => {\n    Object.entries(target).forEach(([key, value]) => {\n        if (! isNullOrUndefined(value) && (isObject(value) || isArray(value))) {\n            target[key] = createObservable(value, callbacks)\n        }\n    })\n\n    return new Proxy(target, {\n        set(target, key, value) {\n            if (! isNullOrUndefined(value) && isObject(value)) {\n                value = createObservable(value, callbacks)\n            }\n\n            callbacks.set(target, key, target[key] = value)\n\n            return true\n        }\n    })\n}","/* global define */\n(function (root, factory) {\n  /* istanbul ignore next */\n  if (typeof define === 'function' && define.amd) {\n    define([], factory);\n  } else if (typeof exports === 'object') {\n    module.exports = factory();\n  } else {\n    root.compareVersions = factory();\n  }\n}(this, function () {\n\n  var semver = /^v?(?:\\d+)(\\.(?:[x*]|\\d+)(\\.(?:[x*]|\\d+)(\\.(?:[x*]|\\d+))?(?:-[\\da-z\\-]+(?:\\.[\\da-z\\-]+)*)?(?:\\+[\\da-z\\-]+(?:\\.[\\da-z\\-]+)*)?)?)?$/i;\n\n  function indexOrEnd(str, q) {\n    return str.indexOf(q) === -1 ? str.length : str.indexOf(q);\n  }\n\n  function split(v) {\n    var c = v.replace(/^v/, '').replace(/\\+.*$/, '');\n    var patchIndex = indexOrEnd(c, '-');\n    var arr = c.substring(0, patchIndex).split('.');\n    arr.push(c.substring(patchIndex + 1));\n    return arr;\n  }\n\n  function tryParse(v) {\n    return isNaN(Number(v)) ? v : Number(v);\n  }\n\n  function validate(version) {\n    if (typeof version !== 'string') {\n      throw new TypeError('Invalid argument expected string');\n    }\n    if (!semver.test(version)) {\n      throw new Error('Invalid argument not valid semver (\\''+version+'\\' received)');\n    }\n  }\n\n  function compareVersions(v1, v2) {\n    [v1, v2].forEach(validate);\n\n    var s1 = split(v1);\n    var s2 = split(v2);\n\n    for (var i = 0; i < Math.max(s1.length - 1, s2.length - 1); i++) {\n      var n1 = parseInt(s1[i] || 0, 10);\n      var n2 = parseInt(s2[i] || 0, 10);\n\n      if (n1 > n2) return 1;\n      if (n2 > n1) return -1;\n    }\n\n    var sp1 = s1[s1.length - 1];\n    var sp2 = s2[s2.length - 1];\n\n    if (sp1 && sp2) {\n      var p1 = sp1.split('.').map(tryParse);\n      var p2 = sp2.split('.').map(tryParse);\n\n      for (i = 0; i < Math.max(p1.length, p2.length); i++) {\n        if (p1[i] === undefined || typeof p2[i] === 'string' && typeof p1[i] === 'number') return -1;\n        if (p2[i] === undefined || typeof p1[i] === 'string' && typeof p2[i] === 'number') return 1;\n\n        if (p1[i] > p2[i]) return 1;\n        if (p2[i] > p1[i]) return -1;\n      }\n    } else if (sp1 || sp2) {\n      return sp1 ? -1 : 1;\n    }\n\n    return 0;\n  };\n\n  var allowedOperators = [\n    '>',\n    '>=',\n    '=',\n    '<',\n    '<='\n  ];\n\n  var operatorResMap = {\n    '>': [1],\n    '>=': [0, 1],\n    '=': [0],\n    '<=': [-1, 0],\n    '<': [-1]\n  };\n\n  function validateOperator(op) {\n    if (typeof op !== 'string') {\n      throw new TypeError('Invalid operator type, expected string but got ' + typeof op);\n    }\n    if (allowedOperators.indexOf(op) === -1) {\n      throw new TypeError('Invalid operator, expected one of ' + allowedOperators.join('|'));\n    }\n  }\n\n  compareVersions.validate = function(version) {\n    return typeof version === 'string' && semver.test(version);\n  }\n\n  compareVersions.compare = function (v1, v2, operator) {\n    // Validate operator\n    validateOperator(operator);\n\n    // since result of compareVersions can only be -1 or 0 or 1\n    // a simple map can be used to replace switch\n    var res = compareVersions(v1, v2);\n    return operatorResMap[operator].indexOf(res) > -1;\n  }\n\n  return compareVersions;\n}));\n","import { domReady, getMethods } from './utils'\nimport { createObservable } from './observable'\nimport compareVersions from 'compare-versions';\n\nconst Spruce = {\n    stores: {},\n\n    persisted: [],\n\n    subscribers: [],\n\n    watchers: {},\n\n    disableReactivity: false,\n\n    async start() {\n        await domReady()\n\n        this.attach()\n\n        this.stores = createObservable(this.stores, {\n            set: (target, key, value) => {\n                if (this.disableReactivity) {\n                    return\n                }\n\n                this.updateSubscribers()\n\n                this.runWatchers(this.stores, target, key, value)\n\n                this.disableReactivity = true\n\n                try {\n                    this.persisted.forEach(this.updateLocalStorage.bind(this))\n                } catch (e) {\n                    // Do nothing here (thanks Safari!)\n                }\n\n                this.disableReactivity = false\n            }\n        })\n    },\n\n    attach() {\n        if (!window.Alpine || ! compareVersions.compare(window.Alpine.version, '2.7.0', '>=')) {\n            throw new Error('[Spruce] You must be using Alpine >= 2.5.0 to use Spruce.')\n        }\n\n        const self = this\n\n        window.Alpine.addMagicProperty('store', el => {\n            self.subscribe(el)\n\n            return self.stores\n        })\n    },\n\n    store(name, state, persist = false) {\n        if (persist) {\n            try {\n                this.stores[name] = this.retrieveFromLocalStorage(name, getMethods(state))\n\n                if (!this.persisted.includes(name)) {\n                    this.persisted.push(name)\n                }\n            } catch (e) {\n                // Do nothing here (thanks Safari!)\n            }\n        }\n\n        if (!this.stores[name]) {\n            this.stores[name] = state\n        }\n\n        return this.stores[name]\n    },\n\n    reset(name, state) {\n        this.stores[name] = state\n    },\n\n    subscribe(el) {\n        if (!this.subscribers.includes(el)) {\n            this.subscribers.push(el)\n        }\n\n        return this.stores\n    },\n\n    updateSubscribers() {\n        this.subscribers.filter(el => !!el.__x).forEach(el => {\n            el.__x.updateElements(el)\n        })\n    },\n\n    retrieveFromLocalStorage(name, methods = {}) {\n        const storage = JSON.parse(window.localStorage.getItem(`__spruce:${name}`))\n\n        return storage ? Object.assign(methods, storage) : null\n    },\n\n    updateLocalStorage(name) {\n        window.localStorage.setItem(`__spruce:${name}`, JSON.stringify(this.store(name)))\n    },\n\n    watch(name, callback) {\n        if (!this.watchers[name]) {\n            this.watchers[name] = []\n        }\n\n        this.watchers[name].push(callback)\n    },\n\n    runWatchers(stores, target, key, value) {\n        const self = this\n\n        if (self.watchers[key]) {\n            return self.watchers[key].forEach(callback => callback(value))\n        }\n\n        Object.keys(self.watchers)\n            .filter(watcher => watcher.includes('.'))\n            .forEach(fullDotNotationKey => {\n                let dotNotationParts = fullDotNotationKey.split('.')\n\n                if (key !== dotNotationParts[dotNotationParts.length - 1]) return\n\n                dotNotationParts.reduce((comparison, part) => {\n                    if (comparison[key] === target[key] || Object.is(target, comparison)) {\n                        self.watchers[fullDotNotationKey].forEach(callback => callback(value))\n                    }\n\n                    return comparison[part]\n                }, stores)\n            })\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || function (callback) { callback() }\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce\n"],"names":["const","isNullOrUndefined","value","isObject","_","Object","getPrototypeOf","prototype","createObservable","target","callbacks","entries","forEach","Array","isArray","key","Proxy","set","module","semver","split","v","str","c","replace","patchIndex","indexOf","length","arr","substring","push","tryParse","isNaN","Number","validate","version","TypeError","test","Error","compareVersions","v1","v2","s1","s2","i","Math","max","n1","parseInt","n2","sp1","sp2","p1","map","p2","undefined","allowedOperators","operatorResMap",">",">=","=","<=","<","compare","operator","op","join","validateOperator","res","factory","Spruce","stores","persisted","subscribers","watchers","disableReactivity","start","this","Promise","resolve","document","readyState","addEventListener","attach","_this","updateSubscribers","runWatchers","updateLocalStorage","bind","e","window","Alpine","self","addMagicProperty","el","subscribe","store","name","state","persist","retrieveFromLocalStorage","methods","filter","includes","reset","__x","updateElements","storage","JSON","parse","localStorage","getItem","assign","setItem","stringify","watch","callback","keys","watcher","fullDotNotationKey","dotNotationParts","reduce","comparison","part","is","deferrer","deferLoadingAlpine"],"mappings":"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"}